## 概述
- 目标：构建“长治三毛业务数据采集展示”Web应用，支持PC与移动端，含登录/中台/展示三页。
- 外部接口：
  - 获取时间键：`GET http://inter.bak365.cn/Service.ashx?Type=GetTimeKay`
  - 业务查询：`POST http://inter.bak365.cn/Service.ashx?AppNo=Test&Type=CardInfo&MAC={M1}`，请求体为JSON：`{"CardNo":"0001"}`
- 后端解决跨域：通过本地后端代理两个外部接口，统一返回JSON并开放本地CORS。

## 技术栈与架构
- 前端：原生 HTML/CSS/JavaScript，响应式布局（Flex/Grid），不依赖第三方库。
- 后端：Node.js（现有 `server.js` 原生 http 服务），新增代理路由与MD5签名生成；使用内置 `crypto` 计算MD5。
- 部署：本地运行 `server.js`（监听 `http://localhost:3000`），前端静态页由同一后端提供。

## 签名与变量定义
- B1：时间键（`TimeKay`），从第一次接口返回 `Data.TimeKay` 取值。
- N1：拼接串，按固定顺序无分隔符拼接：`"Test" + "123456" + "{"CardNo":"0001"}" + B1`
- M1：`MD5(N1)` 的十六进制小写字符串。
- C1：第二个调用地址，将 `MAC` 替换为 `M1` 后的完整URL：`http://inter.bak365.cn/Service.ashx?AppNo=Test&Type=CardInfo&MAC=${M1}`

## 后端接口设计（本地代理）
- `GET /api/timekay`
  - 行为：代理外部时间键接口并转发响应。
  - 返回（示例）：`{"State":true,"Msg":"","Data":{"TimeKay":"3611698"}}`
  - 说明：统一设置CORS，错误时返回原始字符串或转换后的错误对象。
- `POST /api/cardinfo`
  - 入参（JSON）：`{ "B1": string }`
  - 行为：后端根据约定生成 `N1` 和 `M1`，构造 `C1`，向外部接口以 `POST`（`Content-Type: application/json`）发送体：`{"CardNo":"0001"}`。
  - 返回：`{ "req": { "B1": string, "N1": string, "M1": string, "C1": string }, "resp": <外部返回JSON或文本> }`
- 登录接口修正
  - 现有：`POST /api/login` 要求 `username=admin` 且 `password=admin`
  - 需求：将默认密码改为 `123456`，成功返回 `{ user: "admin", token: <uuid> }`

## 前端页面设计
- 页面1：登录页（美观现代）
  - 标题：`长治三毛业务管理`
  - 表单：用户名（默认 `admin`）、密码（默认 `123456`）
  - 操作：`登录`按钮；成功后进入页面2；提供`退出`返回登录页（所有页均有）。
  - 视觉：大标题、居中卡片、圆角、阴影、主色蓝（#2563eb），支持移动端窄屏。
- 页面2：长治三毛业务数据中台
  - 标题：`长治三毛业务数据中台`
  - 操作：按钮`获取业务数据`
    - 点击流程：
      1) `GET /api/timekay` → 解析为对象；若 `State===true` 则取 `Data.TimeKay` 为 `B1`；否则在页底显示原始返回文本并终止。
      2) `POST /api/cardinfo`（请求体：`{B1}`）→ 后端生成并返回 `N1/M1/C1` 及外部响应 `resp`。
      3) 跳转页面3，携带 `B1/N1/M1/C1` 与原始 `resp`。
  - 导航：`退出`返回登录页。
  - 错误区：页底固定区域显示错误文本（保持原样）。
- 页面3：长治三毛业务数据采集展示
  - 标题：`长治三毛业务数据采集展示`
  - 信息区（居中四行）：
    - 第一行：`TimeKay: {B1}  1分钟内有效`
    - 第二行：`MAC: {M1}`
    - 第三行：`调用地址: {C1}`
    - 第四行：`拼接串: {N1}`
  - 原始返回展示：在第四行下，以文本方式显示完整外部返回JSON（`resp`）。
  - 表格展示（基于 `resp.Data`）：表头为 `业务编号, 业务类型, WXOpenID, Balance, Score, ValidTime, State, IssueTime, Name, Mobile, Sex, BirthDate, UpTime`
    - 映射：`CardNo→业务编号, CardType→业务类型, WXOpenID→WXOpenID, Balance→Balance, Score→Score, ValidTime→ValidTime, State→State, IssueTime→IssueTime, Name→Name, Mobile→Mobile, Sex→Sex, BirthDate→BirthDate, UpTime→UpTime`
    - 兼容：若 `Data` 为对象则按一行渲染；为数组则逐行渲染；不存在则显示“暂无数据”。
  - 导航：`返回中台`跳回页面2；`退出`返回登录页。

## 交互流程与校验
- 登录：前端校验非空，后端校验用户名/密码；成功后写入`token`到内存或 `sessionStorage`。
- 获取时间键：解析响应；`State!==true` 时终止并显示原始返回文本（如 `验证失败`）。
- 生成签名：后端按约定拼接并计算MD5；确保使用小写十六进制；`B1`不能为空。
- 请求业务接口：以 `POST` 和 `application/json` 发送体；将完整外部响应透传回前端。
- 导航：所有页面提供返回与退出；移动端点击区域放大；避免误触。

## 响应式与视觉规范
- 布局：容器宽度 `min(960px, 92vw)`；移动端断点 `<=768px` 改为单列、按钮全宽。
- 元素：卡片圆角 `12px`、阴影 `0 6px 16px rgba(0,0,0,.08)`、按钮圆角 `10px`。
- 色彩：主色 `#2563eb`、辅色 `#22c55e`、背景 `#f8fafc`、文本 `#0f172a`。
- 可用性：加载中状态（按钮禁用+微型Spinner）；失败态红色提示；成功态绿色轻提示。

## 错误处理与边界
- 外部返回包含 `State:false` 或 `Msg` 为 `AppNo 错误/验证失败`：在页面2底部原样显示并终止后续流程。
- 网络错误/超时：提示“网络异常，请稍后重试”；不跳转页面3。
- `TimeKay` 过期（>1分钟）：后端与前端不强校验时间，但用户看到“1分钟内有效”提示；若外部接口返回失败则按失败处理。

## 测试用例（关键路径）
- 成功流：
  - 登录：`admin/123456` → 进入页面2。
  - 获取时间键：返回 `{State:true, Data:{TimeKay:"3611698"}}` → 正常继续。
  - 业务查询：返回含 `Data` 的JSON → 页面3显示四行信息、原始JSON文本与表格映射。
- 失败流：
  - 时间键 `State:false` 或结构异常 → 页面2底部显示原始文本“验证失败”，流程终止。
  - 业务查询返回 `AppNo 错误` → 页面3原始JSON显示错误，表格为空。

## 预计改动与文件结构
- 后端：
  - 修改 `server.js`：
    - 新增路由：`GET /api/timekay`、`POST /api/cardinfo`（带MD5生成与外部代理）。
    - 修正登录：`/api/login` 默认密码改为 `123456`。
  - 保持统一CORS响应头（已有 `ok/bad` 实现）。
- 前端静态页：
  - 新增/调整：`login.html`（登录）、`center.html`（中台）、`display.html`（展示）、`styles.css`、`app.js`。
  - 也可采用单页（`index.html`）分区切换；以现有路由 `index.html/main.html` 亦可复用。

## 实施步骤
- 后端先行：实现/验证 `/api/timekay` 与 `/api/cardinfo`，本地代理连通性与MD5逻辑正确。
- 前端联调：
  - 登录页 → 中台页（按钮） → 调用后端 → 展示页渲染信息与表格。
  - 完成响应式与视觉优化。
- 自测与改进：覆盖成功/失败场景；确保导航与退出逻辑正确。

## 安全与合规
- 不持久化用户密码；不在日志打印签名串与敏感变量。
- 仅为演示用途，若上线需加入会话校验、限流与更严密的签名保护。

——以上方案确认后，我将基于现有 `server.js` 快速实现后端代理与三页前端并联调。