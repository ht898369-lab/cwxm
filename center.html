<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>长治三毛业务数据中台</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <section id="biz-center" class="view" style="padding:0 24px">
    <div style="width:90%;margin:5px auto 0">
      <header class="app-header" style="border-radius:0;box-shadow:var(--shadow)">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:46px;height:46px;display:flex;align-items:center;justify-content:center">
            <svg viewBox="0 0 64 64" width="46" height="46" aria-hidden="true">
              <defs>
                <radialGradient id="bg" cx="0.5" cy="0.4" r="0.7">
                  <stop offset="0%" stop-color="#7cc0ff"/>
                  <stop offset="100%" stop-color="#4f46e5"/>
                </radialGradient>
                <linearGradient id="cloud" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#ffffff"/>
                  <stop offset="100%" stop-color="#eef2ff"/>
                </linearGradient>
              </defs>
              <circle cx="32" cy="32" r="28" fill="url(#bg)"/>
              <g fill="#ffffff" opacity="0.9">
                <circle cx="18" cy="20" r="1.5"/>
                <circle cx="26" cy="14" r="1.2"/>
                <circle cx="40" cy="18" r="1.4"/>
                <circle cx="48" cy="26" r="1.1"/>
                <circle cx="22" cy="30" r="1"/>
              </g>
              <path d="M20 40c0-4 3.5-7 7.5-7 .3-5.5 4.8-9.5 10.1-9.5 5.2 0 9.5 3.8 10 9 4.1.2 7.4 3.4 7.4 7.3 0 4.1-3.6 7.4-8 7.4H26.5c-3.6 0-6.5-2.9-6.5-6.2z" fill="url(#cloud)" stroke="#e5e7eb" stroke-width="1.2"/>
              <path d="M12 28 l2 -4 l2 4 l4 2 l-4 2 l-2 4 l-2 -4 l-4 -2z" fill="#ffd166" opacity="0.8"/>
            </svg>
          </div>
          <div style="display:flex;align-items:center;gap:16px">
            <span style="font-weight:700;color:#111827;font-size:28px;line-height:1.1">星空云</span>
            <div class="brand">长治三毛业务数据中台</div>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="user-area"><span id="center-user"></span><button id="center-logout" class="link">退出</button></div>
      </header>
      <div class="panel" style="margin:12px 0 0;box-shadow:var(--shadow)">
        <div style="font-size:16px;font-weight:600;margin-bottom:10px;color:#111827">业务操作</div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
          <button id="fetch-btn" class="primary" style="width:200px">获取业务数据</button>
          <button class="primary" style="width:200px">原材料入库</button>
          <button class="primary" style="width:200px">生产领料出库</button>
          <button class="primary" style="width:200px">产成品入库</button>
          <button id="transfer-btn" class="primary" style="width:200px">销售出库(调拨)</button>
          <button id="delivery-btn" class="primary" style="width:200px">销售出库(配送)</button>
          <button id="start-all-btn" class="primary" style="width:200px">全部启动</button>
          <span id="loading" class="hint" style="display:none">加载中...</span>
        </div>
        <div id="pwd-section" style="margin-top:16px; padding-top:12px; border-top:1px solid #e5e7eb">
          <div id="pwd-title" style="font-size:14px;font-weight:600;margin-bottom:8px;color:#111827;cursor:pointer">修改管理员密码</div>
          <div id="pwd-content" style="display:none;flex-direction:column;align-items:center;gap:8px">
            <input id="old-pwd" type="password" placeholder="当前密码" style="width:200px;padding:8px;border:1px solid #e5e7eb;border-radius:8px" />
            <input id="new-pwd" type="password" placeholder="新密码" style="width:200px;padding:8px;border:1px solid #e5e7eb;border-radius:8px" />
            <input id="new-pwd2" type="password" placeholder="确认新密码" style="width:200px;padding:8px;border:1px solid #e5e7eb;border-radius:8px" />
            <button id="change-pwd-btn" class="secondary" style="width:200px">修改密码</button>
            <div id="pwd-hint" class="hint"></div>
          </div>
        </div>
        <div id="error-box" class="error" style="margin-top:14px;padding:10px;border-radius:10px;background:#fef2f2;border:1px solid #fecaca"></div>
      </div>
    </div>
  </section>

  <script>
    const API=window.location.origin;
    const logoutBtn=document.getElementById('center-logout'); if(logoutBtn){logoutBtn.onclick=()=>{localStorage.removeItem('user'); localStorage.removeItem('token'); window.location.href='/';}};
    const fetchBtn=document.getElementById('fetch-btn');
    const errorBox=document.getElementById('error-box');
    const loading=document.getElementById('loading');
    const token=localStorage.getItem('token'); const user=localStorage.getItem('user'); if(!token||!user){window.location.href='/';}
    document.getElementById('center-user').textContent=user||'';
    const setLoading=(b)=>{if(loading){loading.style.display=b?'inline-block':'none';} if(fetchBtn){fetchBtn.disabled=b;}}
    if(fetchBtn){
      fetchBtn.onclick=async()=>{
        errorBox.textContent=''; setLoading(true);
        try{
          const r=await fetch(`${API}/api/timekay`);
          const txt=await r.text(); let obj=null; try{obj=JSON.parse(txt);}catch(e){obj=null;}
          if(!obj||obj.State!==true||!obj.Data||!obj.Data.TimeKay){ errorBox.textContent=txt; setLoading(false); return; }
          const B1=obj.Data.TimeKay;
          const r2=await fetch(`${API}/api/cardinfo`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({B1})});
          const data=await r2.json();
          const pack={B1:data?.req?.B1||B1, N1:data?.req?.N1||'', M1:data?.req?.M1||'', C1:data?.req?.C1||'', resp:data?.resp};
          sessionStorage.setItem('bizResult', JSON.stringify(pack));
          window.location.href='/display.html';
        }catch(e){ errorBox.textContent='网络异常，请稍后重试'; }
        finally{ setLoading(false); }
      };
    }
    const changeBtn=document.getElementById('change-pwd-btn');
    const oldPwd=document.getElementById('old-pwd');
    const newPwd=document.getElementById('new-pwd');
    const newPwd2=document.getElementById('new-pwd2');
    const pwdHint=document.getElementById('pwd-hint');
    const pwdTitle=document.getElementById('pwd-title');
    const pwdContent=document.getElementById('pwd-content');
    if(pwdTitle){
      pwdTitle.onclick=()=>{
        if(!pwdContent) return;
        const hidden=(pwdContent.style.display==='none' || !pwdContent.style.display);
        pwdContent.style.display=hidden?'flex':'none';
      };
    }
    if(changeBtn){
      changeBtn.onclick=async()=>{
        pwdHint.textContent='';
        const o=(oldPwd?.value||'').trim();
        const n=(newPwd?.value||'').trim();
        const n2=(newPwd2?.value||'').trim();
        if(!o){pwdHint.textContent='当前密码不能为空'; return;}
        if(!n){pwdHint.textContent='新密码不能为空'; return;}
        if(!n2){pwdHint.textContent='确认新密码不能为空'; return;}
        if(n!==n2){pwdHint.textContent='两次输入的新密码不一致'; return;}
        try{
          const r=await fetch(`${API}/api/change-password`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({oldPassword:o,newPassword:n})});
          if(r.ok){ pwdHint.textContent='修改密码成功，请使用新密码登录'; setTimeout(()=>{ localStorage.removeItem('user'); localStorage.removeItem('token'); window.location.href='/'; }, 1200); }
          else{ const t=await r.text(); pwdHint.textContent=t.includes('invalid')?'当前密码错误':'修改失败'; }
        }catch(e){ pwdHint.textContent='网络错误'; }
      };
    }
    const startAllBtn=document.getElementById('start-all-btn');
    if(startAllBtn){
      startAllBtn.onclick=()=>{ window.location.href='/display_all.html'; };
    }
    const transferBtn=document.getElementById('transfer-btn');
    if(transferBtn){
      transferBtn.onclick=()=>{ window.location.href='/display_transfer.html'; };
    }
    const deliveryBtn=document.getElementById('delivery-btn');
    if(deliveryBtn){
      deliveryBtn.onclick=()=>{ window.location.href='/display_delivery.html'; };
    }
  </script>
</body>
</html>